events {}

upstream kong_upstream {
    server kong:8000;
    # 필요하면 더 추가
}

http {
  # 기본 타임아웃 설정
  proxy_connect_timeout 5s;      # 업스트림 서버 연결 타임아웃
  proxy_send_timeout    5s;      # 업스트림 서버로 요청 전송 타임아웃
  proxy_read_timeout    5s;      # 업스트림 서버에서 응답 읽기 타임아웃

  server {
    listen 80;
    server_name _;

    # 인증이 필요 없는 경로 (토큰 발급 등)
    location ~ ^/auth/(login)$ {
      proxy_pass http://kong_upstream;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 그 외 모든 요청은 인증 체크
    location / {
      auth_request /auth_check;
      proxy_pass http://kong_upstream;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location = /auth_check {
      internal;
      proxy_pass http://koa-auth-server:4000/auth/verify;
      proxy_set_header Authorization $http_authorization;
      proxy_pass_request_body off;
      proxy_set_header Content-Length "";
      proxy_set_header X-Original-URI $request_uri;
      
      # 인증 체크 전용 타임아웃 (더 짧게 설정)
      proxy_connect_timeout 3s;
      proxy_send_timeout    3s;
      proxy_read_timeout    3s;
    }
  }
}