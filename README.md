### 경력 단절을 이겨내기 위한 재활 치료 프로젝트

# Fastify Member Platform

회원 관리 및 인증 기능을 제공하는 Node.js 기반의 Fastify 서버 프로젝트입니다.  
Docker, Prisma, PostgreSQL, Koa, Next.js 등 다양한 기술 스택을 활용하여  
모던한 백엔드/풀스택 환경을 구성합니다.

**🔒 보안 정책: Auth API 엔드포인트 보호**
- Next.js BFF(Backend for Frontend) 패턴을 통해 auth API를 내부망에 숨김
- 클라이언트는 Next.js API Routes를 통해서만 인증 서비스에 접근 가능
- HttpOnly 쿠키 기반 보안 강화로 XSS 공격 방어

---

## 주요 기능

- 회원 가입, 로그인, 정보 수정, 삭제
- **🔒 BFF 패턴으로 Auth API 엔드포인트 보호** (직접 접근 차단)
- HttpOnly 쿠키 기반 보안 인증 시스템
- Docker Compose로 전체 서비스 손쉽게 실행
- **Next.js API Routes를 통한 Proxy 서버 역할**
- 사용자 정의 네트워크(app-network)로 서비스 간 통신 격리
- 각 서비스의 Dockerfile 최적화 및 .dockerignore 적용

---

## 폴더 구조

```
.
├── fastify-member-server/   # 회원 관리 서비스
├── koa-auth-server/         # 인증 서비스 (내부망 전용)
├── ecommerce-app/           # 프론트엔드 + BFF Proxy
├── kong/                    # Kong API Gateway 설정
├── docker-compose.yml       # 컨테이너 구성
└── README.md                # 프로젝트 문서
```

---

## 시스템 아키텍처 (🔒 하이브리드 보안)
 - auth server를 client에서 숨기기 위해 정책 변경으로 인한 시스템 아키텍처가 변경됨.

```
┌──────────────┐     HTTP 요청     ┌──────────────────────────────────┐
│              │ ─────────────────►│                                  │
│   클라이언트  │                   │         Next.js                  │
│  (브라우저/앱) │ ◄─────────────── │    (프론트엔드 + BFF)             │
└──────────────┘     HTTP 응답     └────────────┬─────────────────────┘
                                                │
                                                │ API Routes (/api/*)
                                                │ HttpOnly 쿠키 → Bearer 토큰 변환
                                                │
                ┌───────────────────────────────┼─────────────────────────────────┐
                │ 내부 도커 네트워크 (외부 접근 차단) │                                 │
                │                               ▼                                 │
                │         ┌──────────────┐     직접     ┌──────────────┐          │
                │         │              │◄────────────┤              │          │
                │         │  Auth 서비스  │     통신     │              │          │
                │         │   (Koa)      │             │              │          │
                │         └──────┬───────┘             │              │          │
                │                │                     │   Next.js    │          │
                │                ▼                     │  API Routes  │          │
                │         ┌──────────────┐             │              │          │
                │         │    Redis     │             │              │──────────┼───┐
                │         │  (토큰/캐시)  │             └──────────────┘          │   │
                │         └──────────────┘                      │                │   │
                │                                               │ Kong API       │   │
                │                                               ▼ Gateway       │   │
                │                                        ┌──────────────┐       │   │
                │                                        │              │       │   │
                │ ┌──────────────┐                       │     Kong     │       │   │
                │ │              │◄──────────────────────┤ API Gateway  │       │   │
                │ │ Member 서비스 │                       │              │       │   │
                │ │  (Fastify)   │                       └─────┬────────┘       │   │
                │ └──────┬───────┘                             │                │   │
                │        │                                     │                │   │
                │        ▼                                     ▼                │   │
                │ ┌──────────────┐                      ┌──────────────┐       │   │
                │ │  PostgreSQL  │                      │ 기타 서비스들 │◄──────┼───┘
                │ │  (Database)  │                      │(Order,Product│       │
                │ └──────────────┘                      │ Payment 등)  │       │
                │                                       └──────────────┘       │
                └─────────────────────────────────────────────────────────────────┘
```

## 🔄 Kong API Gateway 소개

**Kong**은 마이크로서비스 아키텍처를 위한 오픈소스 API Gateway입니다.

### Kong의 주요 기능
- **API 라우팅**: URL 패턴에 따라 요청을 적절한 마이크로서비스로 전달
- **인증/인가**: JWT, OAuth2, API Key 등 다양한 인증 방식 지원
- **Rate Limiting**: API 호출량 제한으로 서비스 보호
- **로깅/모니터링**: 모든 API 요청에 대한 상세 로그 수집
- **캐싱**: 응답 데이터 캐싱으로 성능 향상
- **🔄 멱등성(Idempotency) 처리**: 중복 요청 방지 및 안전한 재시도 보장
- **보안**: IP 화이트리스트, CORS, SSL 종료 등
- **플러그인**: 200+ 플러그인으로 기능 확장 가능

### 왜 Kong을 사용하나요?
1. **중앙 집중식 관리**: 모든 API 정책을 한 곳에서 관리
2. **마이크로서비스 확장성**: 새로운 서비스 추가 시 쉽게 라우팅 설정
3. **운영 효율성**: 로깅, 모니터링, 알림 등 운영 기능 통합
4. **보안 강화**: 각 서비스별로 개별 보안 정책 적용 가능

### 🔄 Kong 멱등성(Idempotency) 처리

**멱등성**이란 동일한 요청을 여러 번 수행해도 결과가 동일함을 보장하는 성질입니다.

#### Kong 멱등성의 주요 특징
- **중복 요청 감지**: `Idempotency-Key` 헤더를 통한 요청 식별
- **응답 캐싱**: 동일한 멱등성 키로 들어온 요청에 대해 캐시된 응답 반환
- **네트워크 오류 대응**: 타임아웃이나 연결 실패 시 안전한 재시도 가능
- **결제/주문 안전성**: 중요한 비즈니스 로직에서 중복 실행 방지

#### 멱등성이 중요한 API 예시
- **결제 처리**: 중복 결제 방지
- **주문 생성**: 중복 주문 방지  
- **회원 가입**: 중복 계정 생성 방지
- **데이터 수정**: 동일한 수정 작업의 중복 실행 방지

#### Kong 멱등성 플러그인 동작 방식
1. 클라이언트가 `Idempotency-Key` 헤더와 함께 요청 전송
2. Kong이 해당 키로 이전 요청 이력 확인
3. **신규 요청**: 백엔드로 전달 후 응답을 캐시
4. **중복 요청**: 캐시된 응답 즉시 반환 (백엔드 호출 없음)

---

## 요청 흐름 상세 설명 (🔒 하이브리드 BFF 패턴)

### 1. 인증 요청 흐름 (직접 통신) - 보안 우선
```
클라이언트 → Next.js API Routes → Auth 서비스 → Redis → 응답
```
1. **클라이언트 → Next.js**: 인증 관련 API 요청 (`/api/auth/login`, `/api/auth/logout` 등)
2. **Next.js API Routes**: HttpOnly 쿠키에서 토큰 추출
3. **Next.js → Auth 서비스**: Bearer 토큰으로 변환하여 **직접 내부망 요청** (Kong 우회)
4. **Auth 서비스 → Redis**: 토큰 유효성 검증 및 사용자 정보 조회
5. **Auth 서비스 → Next.js**: 인증 결과 응답
6. **Next.js → 클라이언트**: 최종 응답 (HttpOnly 쿠키 설정)

🔒 **보안 이유**: 인증 서비스는 가장 민감한 정보를 다루므로 Kong을 거치지 않고 직접 통신

### 2. 비즈니스 로직 요청 흐름 (Kong API Gateway 경유) - 확장성 우선
```
클라이언트 → Next.js API Routes → Kong API Gateway → 마이크로서비스 → Database → 응답
```
1. **클라이언트 → Next.js**: 비즈니스 데이터 요청 (`/api/member/*`, `/api/order/*`, `/api/product/*` 등)
2. **Next.js API Routes**: 쿠키에서 토큰 추출 및 Bearer 토큰 변환
3. **Next.js → Kong API Gateway**: 인증 헤더와 함께 요청 전달
4. **Kong의 정책 적용**:
   - 🛡️ Rate Limiting: API 호출량 제한
   - 📊 로깅: 모든 요청/응답 로그 수집
   - 🔍 모니터링: 성능 지표 수집
   - 🚀 캐싱: 자주 사용되는 데이터 캐싱
   - 🔄 멱등성 처리: 중복 요청 감지 및 안전한 재시도 보장
5. **Kong → 적절한 마이크로서비스**: 라우팅 및 정책 적용 후 전달
   - **Member 서비스**: 회원 정보, 프로필 관리
   - **Order 서비스**: 주문 처리, 주문 내역
   - **Product 서비스**: 상품 조회, 카탈로그  
   - **Payment 서비스**: 결제 처리
6. **마이크로서비스 → PostgreSQL**: 데이터베이스 작업 수행
7. **마이크로서비스 → Kong → Next.js → 클라이언트**: 응답 반환

⚡ **확장성 이유**: 비즈니스 로직은 Kong의 풍부한 기능을 활용하여 모니터링, 확장, 관리

### 3. 🏗️ 아키텍처 설계 결정사항

#### 왜 하이브리드 패턴을 선택했나요?

**🔒 인증 서비스 (직접 통신)**
- ✅ **최고 보안**: 가장 민감한 정보이므로 레이어 최소화
- ✅ **빠른 응답**: 게이트웨이를 거치지 않아 인증 속도 향상
- ✅ **단순성**: 인증 로직의 복잡성 감소

**⚡ 비즈니스 서비스 (Kong 경유)**
- ✅ **확장성**: 새로운 서비스 추가 시 Kong에서 라우팅만 설정
- ✅ **모니터링**: 모든 API 호출에 대한 통합 모니터링
- ✅ **정책 관리**: Rate limiting, 캐싱, 로깅 등 운영 정책 중앙 관리
- ✅ **부하 분산**: 여러 인스턴스로 트래픽 분산 가능

#### Kong vs 직접 통신 비교표

| 특징 | Kong 경유 | 직접 통신 |
|------|-----------|-----------|
| **보안** | 🟡 중간 (게이트웨이 레이어 추가) | 🟢 높음 (레이어 최소화) |
| **성능** | 🟡 중간 (게이트웨이 오버헤드) | 🟢 빠름 (직접 연결) |
| **모니터링** | 🟢 풍부 (Kong 대시보드) | 🟡 제한적 (직접 구현 필요) |
| **확장성** | 🟢 우수 (플러그인, 정책) | 🟡 제한적 (개별 구현) |
| **운영 편의성** | 🟢 우수 (중앙 관리) | 🔴 복잡 (개별 관리) |

**결론**: 인증은 보안을, 비즈니스 로직은 확장성을 우선시하는 하이브리드 접근

### 주요 특징

- **🔒 BFF 보안 패턴**: Next.js가 모든 API 요청의 중앙 게이트웨이 역할
- **Auth API 보호**: 인증 서비스는 내부망에서만 접근 가능
- **HttpOnly 쿠키**: XSS 공격 방어를 위한 안전한 토큰 저장
- **Docker 네트워크 격리**: 외부에서 백엔드 서비스 직접 접근 차단
- **토큰 관리**: Redis를 통한 빠른 토큰 유효성 검증
- **마이크로서비스 설계**: 각 서비스가 자체 책임 영역 담당

### 4. 🛡️ 보안 특징

- **🔒 Auth API 완전 격리**: 인증 서비스는 Next.js를 통해서만 접근 가능 (외부 직접 접근 차단)
- **🍪 HttpOnly 쿠키**: XSS 공격으로부터 토큰 보호, JavaScript로 접근 불가
- **🌐 Kong의 보안 정책**: Rate limiting, IP 화이트리스트, SSL 종료 등
- **🏗️ 마이크로서비스 확장성**: Kong을 통한 유연한 서비스 라우팅 및 관리  
- **🚪 Single Entry Point**: Next.js가 모든 외부 요청의 통합 게이트웨이 역할
- **🔐 네트워크 격리**: Docker 내부 네트워크로 서비스 간 통신 보호
- **📊 중앙 집중식 로깅**: Kong을 통한 모든 API 호출 추적 및 모니터링

### 5. 🚀 확장성 및 운영 이점

- **새로운 마이크로서비스 추가**: Kong 설정만으로 즉시 라우팅 가능
- **A/B 테스팅**: Kong 플러그인으로 트래픽 분할 테스트
- **성능 최적화**: Kong의 캐싱 및 로드 밸런싱 활용
- **장애 대응**: Circuit breaker, Health check 등으로 안정성 향상
- **🔄 멱등성 보장**: 네트워크 오류나 중복 요청으로부터 안전한 API 호출
- **개발 생산성**: 각 팀이 독립적으로 서비스 개발 및 배포 가능

---

## 빠른 시작

1. **환경 변수 파일 준비**
   - 각 서비스 폴더에 `.env` 파일을 생성하고 환경변수를 설정하세요.

2. **전체 서비스 실행**
   ```bash
   # 환경 변수 설정
   # 각 서비스 폴더에 .env 파일 생성 및 설정

   # Docker로 전체 서비스 실행
   docker-compose -p project-name up --build
   ```

3. **개별 서비스 개발 서버 실행**
   ```bash
   # 예시: Fastify 서버
   cd fastify-member-server
   npm install
   npm run dev
   ```

---

## 주요 기술 스택

- **서버**: Node.js, TypeScript
- **프레임워크**: Fastify, Koa, Next.js
- **ORM**: Prisma ORM
- **데이터베이스**: PostgreSQL, Redis
- **API Gateway**: Kong
- **인프라**: Docker, Docker Compose
- **보안**: BFF 패턴, HttpOnly 쿠키

---

### 아키텍처 개선 (🔒 보안 강화)

```
[BFF 패턴: Backend for Frontend]

┌──────────────┐   HTTP 요청   ┌──────────────────────────────────┐   내부망   ┌──────────────┐
│              │─────────────►│          Next.js                 │───────────►│   API 서버   │
│  브라우저/앱 │               │   (프론트엔드 + API Routes)       │           │(Member/Auth) │
└──────────────┘               └──────────────────────────────────┘           └──────────────┘

✅ 장점:
- Auth API 엔드포인트 완전 숨김 (보안 강화)
- HttpOnly 쿠키로 XSS 공격 방어
- 단순한 아키텍처 (레이어 감소)
- CORS 문제 없음 (동일 오리진)
- 개발/운영 환경 일관성

🔒 보안 정책:
- 클라이언트는 Next.js API Routes를 통해서만 백엔드 접근
- Auth 서비스는 Docker 내부 네트워크에서만 접근 가능
- 모든 인증 토큰은 HttpOnly 쿠키로 안전하게 관리
```



---
## 라이선스

MIT
